---
title: "Moscas Manova"
author:
      - "Matheus Gomes"
      - "Daniela Moraes"
      - "Marcos Ferreira"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

```

#Moscas

##Pacotes
```{r, message = F, warning = F}
source("funcoes.R")
pacotes <- c("ggplot2",
             "magrittr",
             "gridExtra",
             "xtable",
             "dplyr",
             "purrr",
             "tidyr",
             "car")

ipak(pacotes)
options(xtable.comment = FALSE,OutDec = ",")
```

##Lendo Os Dados

```{r}

dados <- read.table("Dados/Moscas.txt")

nomes_COl <- c("Especie" = "Especie",
              "CompAsa" =  "Comprimento da asa",
              "LargAsa" = "Largura da asa",
              "Comp3Palpo" = "Comprimento do terceiro\n palpo",
              "Larg3Palpo" =  "Largura do terceiro palpo", 
              "Comp4Palpo" = "Comprimento do quarto\n palpo",
              "Comp12Antena" = 
           "Comprimento do 12º segmento\n da antena",
            "Comp13Antena" =  "Comprimento do 13º \n segmento da antena")



colnames(dados) <- c("Especie","CompAsa","LargAsa","Comp3Palpo",          "Larg3Palpo","Comp4Palpo","Comp12Antena","Comp13Antena")

Especie_chr <- function(x){
  if (x == 0)
    y <- "torrens"
  else
    y <- "carteri"
}
dados %<>% mutate( Especie_fct = 
                    factor(map_chr(Especie,Especie_chr)))


```


#Analise Descritiva

##Preparação

```{r}
mx <- dados[,2:8] %>% as.matrix()
nvar <- 7
n <- 70
```


##Medidas Descritivas

```{r results = "asis"}

descritivas <- 
dados %>% select_if(.predicate = is.integer) %>% 
  gather(Coluna,valores,-Especie) %>% 
  group_by(Coluna,Especie) %>% 
  summarise_if(.predicate = function(x) is.numeric(x),
                  .funs = c(Média = "mean",
                     DP = "sd",
                     Var. = "var",
                     Mínimo = "min",
                     CV =  "cv",
                     Mediana = "median",
                     Máximo = "max")) %>% 
  mutate_if(.predicate = is.numeric,funs(round(.,3))) %>% 
  mutate(Espécie =  factor(map_chr(Especie,Especie_chr))) %>% 
  select(-Especie)
names(descritivas )[names(descritivas ) == 'CV'] <- 'CV(%)'
descritivas <- descritivas[,c(1,9,2:8)]
descritivas_2 <- nest(descritivas)

for(i in 1:7){
  print.xtable(xtable(descritivas_2$data[[i]], 
         caption = nomes_COl[descritivas_2$Coluna[i]]), include.rownames = F)
}

```



\newpage

##Boxplots

```{r}
##criando funcao para facilitar a criação dos boxplots
boxplots_moscas <- function(coluna){
 qplot(dados$Especie_fct,coluna,geom = "boxplot") + labs(x = "Espécie") + theme_bw()
}

graficos <- apply(dados[,2:8],2,boxplots_moscas)

for(i in 1:7)
 graficos[[i]] <-  graficos[[i]] + labs(y = nomes_COl[i + 1])
  
##print os boxplots
grid.arrange(graficos[[1]], graficos[[2]], 
             graficos[[3]], graficos[[4]])

grid.arrange(graficos[[5]], graficos[[6]], 
             graficos[[7]], 
            layout_matrix = rbind(c(1,1),c(2,3)))


```

##Histograma

```{r}

##criando funcao para facilitar a criação dos boxplots
hist_moscas <- function(coluna){
 qplot(coluna,geom = "histogram",col = I("black"),fill = I("white"),
       binwidth = 1) + theme_bw() 
}

graficos <- apply(dados[,2:8],2,hist_moscas)

for (i in 1:7)
 graficos[[i]] <-  graficos[[i]] + labs(x = nomes_COl[i + 1],y = NULL)
  
##print os boxplots
grid.arrange(graficos[[1]], graficos[[2]], 
             graficos[[3]], graficos[[4]])

grid.arrange(graficos[[5]], graficos[[6]], 
             graficos[[7]], 
            layout_matrix = rbind(c(1,1),c(2,3)))
```

##Diagrama Dispersao


```{r}
cols <- character(nrow(dados))
cols[] <- "black"

cols[dados$Especie_fct == "carteri"] <- "red"
cols[dados$Especie_fct == "torrens"] <- "blue"
pairs(dados[,2:8],col=cols,upper.panel = NULL)
par(xpd = T)
legend("topright", legend = c(levels(dados$Especie_fct)), 
       fill = c("blue","red"))

```



##Distancia de Mahalanobis


```{r}
par(mfrow = c(1,2))

# Envelopes para a forma quadratica
#
mu <- apply(dados[dados$Especie == 0, 2:8], 2, mean)
s2 <- cov(dados[dados$Especie == 0,2:8])
vQ <- n*mahalanobis(mx,center = mu,cov = s2)
qqPlot(vQ, dist = "chisq", df = nvar, col.lines = 1, grid = "FALSE", xlab = "quantil da distribuição qui-quadrado", ylab = "quantil da forma quadratica", cex = 1.2, id.cex = 1.2, main = "Torrens")

##

mu <- apply(dados[dados$Especie == 1, 2:8],2,mean)
s2 <- cov(dados[dados$Especie == 1,2:8])
vQ <- n*mahalanobis(mx,center = mu,cov = s2)

qqPlot(vQ, dist = "chisq", df = nvar, col.lines = 1, grid = "FALSE", xlab = "quantil da distribuição qui-quadrado", ylab = "quantil da forma quadratica", cex = 1.2, id.cex = 1.2, main = "Carteri")

```

#Analise Inferencial


```{r results = "asis"}
m.ajuste <- manova(as.matrix(dados[,2:8]) ~ dados[,9])
Wilks <- summary.manova(m.ajuste,test="Wilks")$stats
Pillai <- summary.manova(m.ajuste,test="Pillai")$stats
Hotelling <- summary.manova(m.ajuste, test = "Hotelling-Lawley")$stats
Roy <- summary.manova(m.ajuste,test = "Roy")$stats
manova_stats <- list("Wilks" = Wilks,
                     "Pillai" =  Pillai,
                     "Hotelling-Lawley" = Hotelling,
                     "Roy" = Roy )
tbl_manova <- data.frame("Estatística" = names(manova_stats),
                         "Valor" = map_dbl(manova_stats,3),
                        "Aproximação.pela.\n.distribuição.F" = map_dbl(manova_stats,5),
                        "p-valor" = "< 0,0001" )  %>%
   mutate_if(.predicate = is.numeric,funs(round(.,2))) %>%
  as.matrix

colnames(tbl_manova ) <-c("Estatística","Valor",
                    "Aproximação pela distribuição F",
                     "p-valor")
tbl_m <- xtable(tbl_manova , main = "Resultado da MANOVA")
align( tbl_m) <- c( 'l', 'p{1.5in}', rep('c',3) )
print.xtable(tbl_m,include.rownames = F)

```


```{r}

```




